export const handler = async (event)=>{try{const payload=JSON.parse(event.body);const data=payload.payload&&payload.payload.data?payload.payload.data:{};const rating=data.rating;const trip=data.trip;const name=data.name||"";const phone=data.phone||"";const best=data.best||"";const improve=data.improve||"";const consent=data.consent||"";if(process.env.SENDGRID_API_KEY&&process.env.NOTIFY_TO_EMAIL){const content=`Nueva rese√±a / New review:\n‚≠ê ${rating}/5\nTipo/Type: ${trip}\nNombre/Name: ${name}\nTel: ${phone}\nMejor/Best: ${best}\nMejorar/Improve: ${improve}\nConsent: ${consent}`;await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{"Authorization":`Bearer ${process.env.SENDGRID_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({personalizations:[{to:[{email:process.env.NOTIFY_TO_EMAIL}]}],from:{email:process.env.NOTIFY_TO_EMAIL},subject:"Nueva rese√±a de transporte / New transport review",content:[{type:"text/plain",value:content}]})})}if(process.env.TWILIO_SID&&process.env.TWILIO_TOKEN&&process.env.TWILIO_FROM&&process.env.AUTO_REPLY_WHATSAPP==="true"&&phone){const body=`¬°Gracias por tu rese√±a! / Thanks for your review! üôå`;const auth=Buffer.from(`${process.env.TWILIO_SID}:${process.env.TWILIO_TOKEN}`).toString("base64");const to=phone.startsWith("whatsapp:")?phone:phone.replace(/\s+/g,"");await fetch(`https://api.twilio.com/2010-04-01/Accounts/${process.env.TWILIO_SID}/Messages.json`,{method:"POST",headers:{"Authorization":`Basic ${auth}`,"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:new URLSearchParams({From:process.env.TWILIO_FROM,To:to,Body:body})})}return{statusCode:200,body:JSON.stringify({ok:true})}}catch(e){return{statusCode:200,body:JSON.stringify({ok:false,error:e.message})}}};
